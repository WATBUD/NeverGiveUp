<style>body {color: white; background-color: black;}</style>
<script src="dat.gui.min.js"></script>
<script src="effect_coordinate.js"></script>
<script src="effect_color.js"></script>
<script src="manager.js"></script>

<audio id="audio" src="bensound-summer-20sec.mp3" controls></audio>
<input type="file" id="input"></input>
<img src="keyboard.png" id="keyboard.png" style="display: none;">
<img src="mouse.png" id="mouse.png" style="display: none;">
<div id="output" style="font-size: 12pt; text-align: left; height: 1.5em;"></div>
<style>canvas {border: 1px dashed lightgray;}</style>
<canvas id="canvas" width="980" height="300"></canvas>


<button class="select" onmousedown ="manager.selectAll(false);" mode="selectNone"   >清除燈光</button>
<button class="toggle" mode="selectSegment">點選燈光</button>
<button class="toggle" mode="selectRegion" >框選燈光</button>
<button class="select" onmousedown ="manager.selectAll(true);" mode="selectAll"    >全選燈光</button>
|
<button class="toggle" mode="dragDevice"          >拖曳鍵盤滑鼠</button>
<button class="device" mode="pushDevice(keyboard)">新增鍵盤</button>
<button class="device" mode="pushDevice(mouse)"   >新增滑鼠</button>
<button class="device" mode="popDevice"           >移除設備</button>
|<br>

<button class="opacity" onmousedown ="manager.setOpacity(1.0)"  mode="setOpacity(1.0)">通通不透明</button>
<button class="opacity" onmousedown ="manager.setOpacity(0.5)"  mode="setOpacity(0.5)">通通半透明</button>
<button class="blend" onmousedown ="manager.setBlendMode('add');" mode="setBlendMode('add')"      >通通相加</button>
<button class="blend" onmousedown ="manager.setBlendMode('maximum');" mode="setBlendMode('maximum')"  >通通最大值</button>
<button class="blend" onmousedown ="manager.setBlendMode('overlap');" mode="setBlendMode('overlap')"  >通通重疊</button>
<button class="blend" onmousedown ="manager.setBlendMode('overwrite');" mode="setBlendMode('overwirte')">通通覆寫</button>
|
<button class="color" onmousedown ="manager.removeColor();" mode="createColor">減少色彩(↑)</button>
<button class="color" onmousedown ="manager.createColor();" mode="removeColor">增加色彩(↓)</button>
|<br>
<button class="effect" onmousedown ="manager.changeEffect(-1);" mode="changeEffect(-1)">上個燈效(←)</button>
<button class="effect" onmousedown ="manager.changeEffect(+1);" mode="changeEffect(+1)">下個燈效(→)</button>
<button class="effect" onmousedown ="manager.deleteEffect();" mode="deleteEffect">刪除燈效(Del)</button>
|<br>
<div class="effect" mode="insertAfterEffect" style="display: inline;"></div>
<br>
<input type="checkbox" id="all">顯示全部燈效</input>
<input type="checkbox" id="draw">停止繪圖、維持計算、然後你可以測CPU rate</input>
<br><div id="fps"></div>


<script id="utility.dat.gui.js">
var eachController = function(func) {
	for (var controllerName in dat.controllers)
		if (dat.controllers.hasOwnProperty(controllerName))
			func(dat.controllers[controllerName]);
}

var setTitle = function(v) {
	// __li is the root dom element of each controller
	if (v) this.__li.setAttribute('title', v);
	else   this.__li.removeAttribute('title');
	return this;
};

eachController(function(controller) {
	if (!controller.prototype.hasOwnProperty('title'))
		controller.prototype.title = setTitle;
});
CanvasRenderingContext2D.prototype.roundRect = function(x, y, width, height, radius) {
	if (typeof radius === 'undefined') {radius = 0;}
	this.beginPath();
	this.moveTo(x + radius, y);
	this.lineTo(x + width - radius, y);
	this.quadraticCurveTo(x + width, y, x + width, y + radius);
	this.lineTo(x + width, y + height - radius);
	this.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
	this.lineTo(x + radius, y + height);
	this.quadraticCurveTo(x, y + height, x, y + height - radius);
	this.lineTo(x, y + radius);
	this.quadraticCurveTo(x, y, x + radius, y);
	this.closePath();
	return this;
}
</script>
<script src="audio.js"></script>
<script src="device.js"></script>
<script id="bitmap.js">
class Bitmap {
	constructor(size, region) {
		this.size = size;	// KEY WIDTH & HEIGHT
		this.X = Math.ceil(region.width  / this.size);
		this.Y = Math.ceil(region.height / this.size);
		this.array = new Array(this.Y + 1);
		for (let y=0; y<this.array.length; ++y)
			this.array[y] = new Float32Array(this.X).fill(0);
	}
	read(x, y, region, index) {
		x = (x - region.x1) / this.size; var x0 = x | 0;
		y = (y - region.y1) / this.size; var y0 = y | 0;
		var inside = (x0 >= 0 && x0 < this.X
				   && y0 >= 0 && y0 < this.Y);
		if (index || !inside) return [inside, x0, y0, 0];
		var x1 = x0 + 1; if (x1 == this.X) x1 = x0;
		var y1 = y0 + 1; if (y1 == this.Y) y1 = y0;
		var s1 = x - x0; var s0 = 1 - s1;
		var t1 = y - y0; var t0 = 1 - t1;
//		var scale = this.array[y0][x0];
		var scale = s0 * (t0 * this.array[y0][x0] + t1 * this.array[y1][x0])
		          + s1 * (t0 * this.array[y0][x1] + t1 * this.array[y1][x1]);
		return [inside, x0, y0, scale];
	}
}
</script>
<script  src="effect.js"></script>
<script>
// import foo from './effect_coordinate.js';
// console.log(foo);	
var output = document.getElementById("output");
var imageKeyboard = document.getElementById("keyboard.png");
var imageMouse    = document.getElementById("mouse.png");
var manager = new Manager();
var images_count = 0;
var images = document.querySelectorAll("img");
for (let image of images) image.onload = init;

function init() {
	if (++images_count < images.length) return;
	manager.pushDevice(new Device('keyboard', keyboard, keycodes, imageKeyboard));
//	manager.pushDevice(new Device('mouse', mouse, null, imageMouse));
	manager.pushEffect(new Band());
//	manager.pushEffect(new Wave());
//	manager.pushEffect(new Fire());
//	manager.pushEffect(new Spectrum());
}

var keydown = new Set();//by louis ES6 中如果希望「陣列（Array）」的元素不會重複，可以使用 Set；如果是希望物件（Object）的鍵不會重複，則可以使用 Map。
document.addEventListener('keydown', function(e){
	if (keydown.has(e.code)) return;
	keydown.add(e.code);
	manager.event('keyboard', e.code, true);
});
document.addEventListener('keyup', function(e){
	keydown.delete(e.code);
	manager.event('keyboard', e.code, false);
});
document.addEventListener('mousedown', function(e){
	if (e.target.constructor.name === 'HTMLCanvasElement')
		manager.event('mouse', null, true);
});
document.addEventListener('mouseup', function(e) {
	if (e.target.constructor.name === 'HTMLCanvasElement')
		manager.event('mouse', null, false);
});

window.onkeydown = function(e) {
//	e.preventdefault();
//	e.stopPropagation();
    console.log('window.onkeydown ',e.code);
	if      (e.code === 'ArrowUp')    {manager.removeColor(); return;}
	else if (e.code === 'ArrowDown')  {manager.createColor(); return;}
	else if (e.code === 'ArrowLeft')  {manager.changeEffect(-1); return;}
	else if (e.code === 'ArrowRight') {manager.changeEffect(+1); return;}
	else if (e.code === 'Delete')     {manager.deleteEffect(); return;}
//	else if (e.code === 'KeyZ') {manager.toggleScale(); return;}
}
</script>
<script id="main.js">
	var fps = document.getElementById("fps");
	var lastDate = 0, thisDate = 0, diffDate = 0, frame = 0;

	var id;
	window.onload = function() {
//		if (id) cancelAnimationFrame(id);
//		id = requestAnimationFrame(simulation);
		if (id) clearInterval(id);
		id = setInterval(simulation, 100);

		lastDate = performance.now();
		setInterval(function(){
			diffDate = thisDate - lastDate;
			fps.innerHTML = (1000 * frame / diffDate).toFixed(1) + " fps";
			lastDate = thisDate;
			frame = 0;
		}, 1000);
	}
	var canvas = document.getElementById("canvas");
	var ctx    = canvas.getContext('2d');

	var scale = 0.5;
	ctx.scale(scale, scale);

	var all = false;
	var draw = true;
	function simulation(now) {
//		id = requestAnimationFrame(simulation);
//		thisDate = now;
		thisDate = performance.now();
		frame ++;
		main();
	};

	function main() {
		if (audioCapture.onplay) audioCapture.update();
		manager.update();
		all ? manager.renderAll() : manager.render();
		if (draw) {
			ctx.clearRect(0, 0, canvas.width / scale, canvas.height / scale);
			all ? manager.drawAll(ctx) : manager.draw(ctx);
			drawSelectRegion(ctx);
		}
	}
</script>
<script id="button.js">
	var toggle_buttons = document.querySelectorAll("button.toggle");
	var button_mode = '';

	function toggleButton(button) {
		for (let b of toggle_buttons) if (b != button) {
			b.style.borderStyle = '';
		}
		if (button == null) return;
		if (button_mode == button.getAttribute('mode')) {
			button.style.borderStyle = '';
			button_mode = '';
		} else {
			button.style.borderStyle = 'inset';
			button_mode = button.getAttribute('mode');
		}
	}

	for (let button of toggle_buttons)
		button.onmousedown = function(e) {toggleButton(button);}

	var selectRegion = false;
	var x1 = 0, y1 = 0, x2 = 0, y2 = 0;

	function drawSelectRegion(ctx) {
		if (!selectRegion) return;
		ctx.lineWidth = 2;
		ctx.fillStyle = "rgba(128,128,128,0.3)";
		ctx.strokeStyle = "rgba(192,192,192,0.3)";
		ctx.beginPath();
		ctx.rect(x1, y1, x2 - x1, y2 - y1);
		ctx.fill();
		ctx.stroke();
	}

	var mouse_pressed = false;
//	canvas.tabIndex = 1;
	canvas.style.position = "relative";

	canvas.addEventListener('mousedown', function(e){
		mouse_pressed = true;
		x1 = x2 = Math.round(e.layerX / scale);
		y1 = y2 = Math.round(e.layerY / scale);
		if (button_mode === '') {
			manager.setLocation(x1, y1);
		} else if (button_mode === 'selectSegment') {
			manager.selectSegment(x1, y1, x1, y1, true);
		} else if (button_mode === 'selectRegion') {
			selectRegion = true;
		} else if (button_mode === 'dragDevice') {
			manager.holdDevice(x1, y1);
		}
	});
	canvas.addEventListener('mouseup', function(e){
		if (!mouse_pressed) return;
		mouse_pressed = false;
		var xt = x2;
		var yt = y2;
		x2 = Math.round(e.layerX / scale);
		y2 = Math.round(e.layerY / scale);
		if (button_mode === 'selectSegment') {
			manager.selectSegment(xt, yt, x2, y2, true);
		} else if (button_mode === 'selectRegion') {
			manager.selectRegion(x1, y1, x2, y2, true);
			selectRegion = false;
		} else if (button_mode === 'dragDevice') {
			manager.dragDevice(x2 - xt, y2 - yt);
			manager.dropDevice();
		}
	});
	canvas.addEventListener('mouseout', function(e){
		if (!mouse_pressed) return;
		mouse_pressed = false;
		var xt = x2;
		var yt = y2;
		var rect = canvas.getBoundingClientRect();
		x2 = Math.round((e.clientX - rect.left) / scale);
		y2 = Math.round((e.clientY - rect.top)  / scale);
		if (button_mode === 'selectSegment') {
			manager.selectSegment(xt, yt, x2, y2, true);
		} else if (button_mode === 'selectRegion') {
			manager.selectRegion(x1, y1, x2, y2, true);
			selectRegion = false;
		} else if (button_mode === 'dragDevice') {
			manager.dragDevice(x2 - xt, y2 - yt);
			manager.dropDevice();
		}
	});
	canvas.addEventListener('mousemove', function(e){
		if (!mouse_pressed) return;
		var xt = x2;
		var yt = y2;
		x2 = Math.round(e.layerX / scale);
		y2 = Math.round(e.layerY / scale);
		if (button_mode === 'selectSegment') {
			manager.selectSegment(xt, yt, x2, y2, true);
		} else if (button_mode === 'dragDevice') {
			manager.dragDevice(x2 - xt, y2 - yt);
		}
	});
	var device_buttons = document.querySelectorAll("button.device");
	device_buttons[0].onmousedown = function(e) {manager.pushDevice(new Device('keyboard', keyboard, keycodes, imageKeyboard));}
	device_buttons[1].onmousedown = function(e) {manager.pushDevice(new Device('mouse', mouse, null, imageMouse));}
	device_buttons[2].onmousedown = function(e) {manager.popDevice();}
	
	// var script = document.querySelector("script#effect\\.js");
	// console.log('script',script);
	// var script2 = document.querySelector('script[src~="effect.js"]');
	// console.log(script2);
	// var re = /class (.*) extends/g;
	// var classes = [];
	// for (let m; m = re.exec(script.innerHTML); ) {
	// 	console.log('classes.push',m);
	// 	classes.push(m[1]);
	// }
	// var re = /this\.description \= "(.*)";/g;
	// var descriptions = [];
	// for (let m; m = re.exec(script.innerHTML); ) descriptions.push(m[1]);
	var div = document.querySelector("div.effect");
	for (let i=0; i<EffectArrayclass.length; i++) {
		var classname = EffectArrayclass[i].constructor.name;   // == "Foo"
		console.log('classname',classname);

		var button = document.createElement('button');
		button.innerHTML =  EffectArrayclass[i].description + '<br>' + classname;
        var _this=this;
		button.onmousedown = function(e) {
			var T=eval('new ' + EffectArrayclass[i].constructor.name + '()');
			//console.log('eval(',T,_this.classname,classname);
			manager.insertAfterEffect(T);

			//manager.insertAfterEffect(eval('new ' + classname + '()'));
		}
		//console.log(button);
		div.appendChild(button);
	}

	var checkbox = document.querySelector("input#all");
	checkbox.checked = all;
	checkbox.onchange = function(e) {
		all = e.target.checked;
		//for (let radio of radios) radio.disabled = !e.target.checked;
	}

	var checkbox = document.querySelector("input#draw");
	checkbox.checked = !draw;
	checkbox.onchange = function(e) {draw = !e.target.checked;}
</script>
<script id="fps.js">
	
</script>
